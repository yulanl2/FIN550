---
title: "ProblemSet1"
output: html_document
date: "2025-11-13"
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(haven)
library(broom)
library(dplyr)
participant <- read_dta("https://reifjulian.github.io/illinois-wellness-data/data/stata/participation.dta")
head(participant)
```


# Q3
```{r, echo=FALSE}
round(mean(participant$screening2017_c[participant$treat == 1], na.rm = TRUE),4)
sum(participant$screening2017_c[participant$treat == 1], na.rm = TRUE)
```

# Q4
```{r, echo=FALSE}
claims <- read_dta("https://reifjulian.github.io/illinois-wellness-data/data/stata/claims.dta")

baseline_vars <- c(
  "male",
  "age50",
  "age37_49",
  "white",
  "covg_0715_0716",
  "covg_1015_0716",
  "diabetes_1015_0716",
  "hyperlipidemia_1015_0716",
  "hypertension_1015_0716",
  "nonzero_spend_0715_0716",
  "pcp_any_office_1015_0716",
  "pcp_any_visits_1015_0716",
  "pcp_total_office_1015_0716",
  "pcp_total_visits_1015_0716",
  "pos_er_critical_1015_0716",
  "pos_hospital_1015_0716",
  "pos_office_outpatient_1015_0716",
  "spendHosp_0715_0716",
  "spendOff_0715_0716",
  "spendRx_0715_0716",
  "spend_0715_0716"
)

results_q4 <- data.frame(
  variable = character(),
  control_mean = numeric(),
  treat_mean = numeric(),
  p_value = numeric()
)

for (v in baseline_vars) {
  
  control_mean <- mean(claims[[v]][claims$treat == 0], na.rm = TRUE)
  treat_mean <- mean(claims[[v]][claims$treat == 1], na.rm = TRUE)
  
  model <- lm(claims[[v]] ~ claims$treat)
  p_value <- summary(model)$coefficients[2, 4]
  
  results_q4 <- rbind(
    results_q4,
    data.frame(
      variable = v,
      control_mean = control_mean,
      treat_mean = treat_mean,
      p_value = p_value
    )
  )
}

results_q4
```

Overall, all baseline variables have p-values larger than 0.05, with the smallest around 0.085. This indicates that none of the pre-treatment outcomes differ significantly between the treatment and control groups. Therefore, the random assignment appears successful, and the two groups are well balanced before the program started.

# Q5
```{r, echo=FALSE}
outcomes_1yr <- c(
  "covg_0816_0717",
  "diabetes_0816_0717",
  "hyperlipidemia_0816_0717",
  "hypertension_0816_0717",
  "nonzero_spend_0816_0717",
  "pcp_any_office_0816_0717",
  "pcp_any_visits_0816_0717",
  "pcp_total_office_0816_0717",
  "pcp_total_visits_0816_0717",
  "pos_er_critical_0816_0717",
  "pos_hospital_0816_0717",
  "pos_office_outpatient_0816_0717",
  "spendHosp_0816_0717",
  "spendOff_0816_0717",
  "spendRx_0816_0717",
  "spend_0816_0717"
)


results_q5 <- data.frame(
  variable = character(),
  diff_no_controls  = character(),
  diff_with_controls = character(),
  stringsAsFactors = FALSE
)

for (v in outcomes_1yr) {

  # Model 1: no controls
  t1 <- tidy(lm(as.formula(paste(v, "~ treat")), data = claims), conf.int = TRUE, conf.level = 0.95)
  beta1 <- t1$estimate[t1$term == "treat"]
  se1 <- t1$std.error[t1$term == "treat"]

  # Model 2: with controls
  t2 <- tidy(lm(as.formula(paste(v, "~ treat + male + white + age37_49 + age50")), data = claims), conf.int = TRUE, conf.level = 0.95)
  beta2 <- t2$estimate[t2$term == "treat"]
  se2 <- t2$std.error[t2$term == "treat"]

  results_q5 <- rbind(
    results_q5,
    data.frame(
      variable = v,
      diff_no_controls  = paste0(round(beta1, 4), " (", round(se1, 4), ")"),
      diff_with_controls = paste0(round(beta2, 4), " (", round(se2, 4), ")"),
      stringsAsFactors = FALSE
    )
  )
}

results_q5
```

The estimated differences between treatment and control groups are very small across all outcomes, and none are statistically meaningful. This indicates that the wellness program did not affect medical spending, diagnoses, or health care utilization in the first year after randomization. Adding demographic controls produces nearly identical estimates, showing that pre treatment characteristics do not drive the results. Therefore, the findings provide no evidence of a causal effect of the wellness program during the first year.

# Q6
```{r, echo=FALSE}
results_q6 <- data.frame(
  variable = character(),
  diff_no_controls  = character(),
  diff_with_controls = character(),
  stringsAsFactors = FALSE
)

for (v in outcomes_1yr) {

  # Model 3: no controls
  t3 <- tidy(lm(as.formula(paste(v, "~ hra_c_yr1")), data = claims), conf.int = TRUE, conf.level = 0.95)
  beta3 <- t3$estimate[t3$term == "hra_c_yr1"]
  se3 <- t3$std.error[t3$term == "hra_c_yr1"]

  # Model 4: with controls
  t4  <- tidy(lm(as.formula(paste(v, "~ hra_c_yr1 + male + white + age37_49 + age50")), data = claims), conf.int = TRUE, conf.level = 0.95)
  beta4 <- t4$estimate[t4$term == "hra_c_yr1"]
  se4 <- t4$std.error[t4$term == "hra_c_yr1"]

  results_q6 <- rbind(
    results_q6,
    data.frame(
      variable = v,
      diff_no_controls  = paste0(round(beta3, 4), " (", round(se3, 4), ")"),
      diff_with_controls = paste0(round(beta4, 4), " (", round(se4, 4), ")"),
      stringsAsFactors = FALSE
    )
  )
}

results_q6
```
